import React, { useMemo, useState } from "react";

// Root to Recipe â€“ Fixed Box + Pantry + Addâ€‘ons (v0.3)
// Notes:
// - Fixed veg box (Medium Veg Box) starts basket at Â£16.95
// - Pantry items are always visible with checkboxes (never removed). All ticked by default = â€œI already have thisâ€.
//   If a pantry item is unticked, it is added to the basket. It only shows a price if Riverford sells it.
// - Optional addâ€‘ons (e.g., halloumi, pasta, meat, meat boxes) have Add/Remove toggles.
//   Selecting an addâ€‘on displays how many additional recipes it unlocks and lists those recipes under the addâ€‘on.
// - Recipe count badge styled like a billiard ball (green circle) shows base + unlocked counts.
// - Styling aims to match Riverford: light beige background, forest green headings, clean UI, large readable type.

// Helper: currency format
const fmtGBP = (n: number) => new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" }).format(n);

// Types
type PantryItem = {
  id: string;
  name: string;
  hasPrice: boolean;
  price?: number; // present only if hasPrice
};

type AddOn = {
  id: string;
  name: string;
  price: number;
  recipes: string[]; // recipes this addâ€‘on unlocks
};

// Mock Data â€“ can be replaced with live catalogue data later
const VEG_BOX = { id: "medium-box", name: "Medium Veg Box", price: 16.95 } as const;

const BASE_RECIPES: string[] = [
  "Herby roast squash & chickpeas",
  "Simple green veg stir-fry",
  "Tomato & basil pasta bake",
  "Roasted roots with tahini drizzle",
  "Leek & potato frittata",
];

const PANTRY: PantryItem[] = [
  { id: "olive-oil", name: "Olive oil", hasPrice: true, price: 3.5 },
  { id: "sea-salt", name: "Sea salt", hasPrice: false },
  { id: "black-pepper", name: "Black pepper", hasPrice: false },
  { id: "garlic", name: "Garlic bulb", hasPrice: true, price: 0.6 },
  { id: "onion", name: "Onion", hasPrice: true, price: 0.35 },
  { id: "dried-herbs", name: "Dried herbs", hasPrice: false },
  { id: "chilli-flakes", name: "Chilli flakes", hasPrice: false },
];

const ADD_ONS: AddOn[] = [
  {
    id: "halloumi",
    name: "Halloumi (200g)",
    price: 3.95,
    recipes: [
      "Griddled halloumi & courgette salad",
      "Halloumi traybake with roots",
    ],
  },
  {
    id: "artisan-pasta",
    name: "Artisan pasta (500g)",
    price: 2.25,
    recipes: [
      "Pasta primavera with seasonal veg",
      "Roasted tomato linguine",
      "Creamy leek tagliatelle",
    ],
  },
  {
    id: "meat-selection",
    name: "Organic meat selection",
    price: 9.95,
    recipes: [
      "Sausage & root veg bake",
      "Beef & kale ragu",
    ],
  },
  {
    id: "meat-box",
    name: "Small meat box",
    price: 18.5,
    recipes: [
      "Roast chicken with seasonal sides",
      "Pork chops with apple & cabbage",
      "Speedy beef stir-fry",
    ],
  },
];

export default function RootToRecipe() {
  // Pantry checkboxes (all selected by default)
  const [pantrySelected, setPantrySelected] = useState<Record<string, boolean>>(
    () => Object.fromEntries(PANTRY.map((p) => [p.id, true]))
  );

  // Addâ€‘on selections
  const [addedAddOns, setAddedAddOns] = useState<Record<string, boolean>>({});

  const toggleAddOn = (id: string) =>
    setAddedAddOns((prev) => ({ ...prev, [id]: !prev[id] }));

  const togglePantry = (id: string) =>
    setPantrySelected((prev) => ({ ...prev, [id]: !prev[id] }));

  // Basket composition
  const basketLines = useMemo(() => {
    const lines: { id: string; name: string; price?: number }[] = [];
    // Fixed veg box (always present)
    lines.push({ id: VEG_BOX.id, name: VEG_BOX.name, price: VEG_BOX.price });

    // Addâ€‘ons added
    ADD_ONS.forEach((ao) => {
      if (addedAddOns[ao.id]) {
        lines.push({ id: ao.id, name: ao.name, price: ao.price });
      }
    });

    // Pantry: if unticked, add to basket (price only if Riverford sells it)
    PANTRY.forEach((p) => {
      if (!pantrySelected[p.id]) {
        lines.push({ id: `pantry-${p.id}`, name: p.name, price: p.hasPrice ? p.price : undefined });
      }
    });

    return lines;
  }, [addedAddOns, pantrySelected]);

  const basketTotal = useMemo(() => {
    return basketLines.reduce((sum, l) => sum + (typeof l.price === "number" ? l.price : 0), 0);
  }, [basketLines]);

  // Recipes
  const unlockedRecipes = useMemo(() => {
    const lists: string[] = [];
    Object.entries(addedAddOns).forEach(([id, on]) => {
      if (on) {
        const found = ADD_ONS.find((a) => a.id === id);
        if (found) lists.push(...found.recipes);
      }
    });
    return lists;
  }, [addedAddOns]);

  const totalRecipeCount = BASE_RECIPES.length + unlockedRecipes.length;

  return (
    <div className="min-h-screen w-full bg-[#f8f3e7] text-[#273b2b] antialiased">
      {/* Brand font & theme */}
      <style>{`
        @font-face { font-family: 'Riverford'; src: url('/fonts/Riverford-Regular.ttf') format('truetype'); font-weight: 400; font-style: normal; font-display: swap; }
        :root { --rf-green: #2f4f39; --rf-green-700: #274231; --rf-beige: #f8f3e7; --rf-accent: #3f6b4f; }
        .rf-font { font-family: 'Riverford', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
        .billiard { background: radial-gradient( circle at 35% 30%, #6ea67f 0%, #3b7d57 40%, #2e5f43 70%, #274231 100% ); }
      `}</style>

      <div className="rf-font max-w-6xl mx-auto px-4 py-8">
        {/* Header */}
        <header className="flex items-start gap-4 mb-6">
          <div className="billiard w-16 h-16 rounded-full flex items-center justify-center shadow-md shrink-0">
            <span className="text-white text-2xl font-semibold drop-shadow">{totalRecipeCount}</span>
          </div>
          <div>
            <h1 className="text-3xl md:text-4xl font-semibold text-[var(--rf-green)]">Root to Recipe</h1>
            <p className="text-sm md:text-base text-[#435e4b]">Start from a fixed veg box, tick what you already have in your pantry, then add optional extras to unlock more Riverford recipes.</p>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left column: fixed box & addâ€‘ons */}
          <section className="lg:col-span-2 space-y-6">
            {/* Fixed box */}
            <div className="bg-white/70 backdrop-blur rounded-2xl p-4 md:p-6 shadow-sm border border-black/5">
              <h2 className="text-2xl font-semibold text-[var(--rf-green)] mb-3">Fixed veg box</h2>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-[var(--rf-green)]/10 flex items-center justify-center">
                    <span className="text-[var(--rf-green)] font-medium">ðŸ¥•</span>
                  </div>
                  <div>
                    <div className="text-lg md:text-xl font-medium">{VEG_BOX.name}</div>
                    <div className="text-sm text-[#526b5a]">Always included</div>
                  </div>
                </div>
                <div className="text-xl md:text-2xl font-semibold text-[var(--rf-green)]">{fmtGBP(VEG_BOX.price)}</div>
              </div>
            </div>

            {/* Addâ€‘ons */}
            <div className="bg-white/70 backdrop-blur rounded-2xl p-4 md:p-6 shadow-sm border border-black/5">
              <h2 className="text-2xl font-semibold text-[var(--rf-green)] mb-4">Optional addâ€‘ons</h2>
              <ul className="space-y-4">
                {ADD_ONS.map((ao) => {
                  const on = !!addedAddOns[ao.id];
                  return (
                    <li key={ao.id} className="rounded-xl border border-black/5 p-4 bg-white/80">
                      <div className="flex flex-wrap items-center gap-3 justify-between">
                        <div className="flex items-center gap-3">
                          <div className="billiard w-8 h-8 rounded-full flex items-center justify-center shadow-sm">
                            <span className="text-white text-sm font-semibold">{ao.recipes.length}</span>
                          </div>
                          <div>
                            <div className="text-lg md:text-xl font-medium">{ao.name}</div>
                            <div className="text-xs text-[#526b5a]">Unlocks {ao.recipes.length} recipe{ao.recipes.length !== 1 ? 's' : ''}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="text-lg md:text-xl font-semibold text-[var(--rf-green)]">{fmtGBP(ao.price)}</div>
                          <button
                            onClick={() => toggleAddOn(ao.id)}
                            className={`px-4 py-2 rounded-xl text-sm font-semibold shadow-sm border transition active:scale-[0.98] ${
                              on
                                ? "bg-[var(--rf-green)] text-white border-[var(--rf-green)]"
                                : "bg-white text-[var(--rf-green)] border-[var(--rf-green)]"
                            }`}
                            aria-pressed={on}
                          >
                            {on ? "Remove" : "Add"}
                          </button>
                        </div>
                      </div>

                      {/* Unlocked recipes under selected addâ€‘on */}
                      {on && (
                        <div className="mt-3 pl-11">
                          <div className="text-sm text-[#3e5a45] mb-1">Recipes unlocked:</div>
                          <ul className="list-disc pl-5 text-sm md:text-base space-y-1">
                            {ao.recipes.map((r, i) => (
                              <li key={i}>{r}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </li>
                  );
                })}
              </ul>
            </div>
          </section>

          {/* Right column: Pantry + Basket */}
          <section className="space-y-6">
            {/* Pantry */}
            <div className="bg-white/70 backdrop-blur rounded-2xl p-4 md:p-6 shadow-sm border border-black/5">
              <h2 className="text-2xl font-semibold text-[var(--rf-green)] mb-3">Your pantry</h2>
              <p className="text-sm text-[#526b5a] mb-3">Tick what you already have. Unticked items will be added to your basket. Prices only show for pantry items that Riverford sells.</p>
              <ul className="space-y-3">
                {PANTRY.map((p) => {
                  const checked = pantrySelected[p.id];
                  return (
                    <li key={p.id} className="flex items-center justify-between gap-3 rounded-xl border border-black/5 p-3 bg-white/80">
                      <label className="flex items-center gap-3 cursor-pointer select-none">
                        <input
                          type="checkbox"
                          className="w-5 h-5 accent-[var(--rf-green)]"
                          checked={checked}
                          onChange={() => togglePantry(p.id)}
                        />
                        <span className="text-base md:text-lg">{p.name}</span>
                      </label>
                      <div className="text-sm md:text-base text-[var(--rf-green)]/80">
                        {p.hasPrice ? fmtGBP(p.price!) : <span className="opacity-60">No Riverford price</span>}
                      </div>
                    </li>
                  );
                })}
              </ul>
            </div>

            {/* Basket */}
            <div className="bg-white/80 rounded-2xl p-4 md:p-6 shadow-sm border border-black/5 sticky top-4">
              <h2 className="text-2xl font-semibold text-[var(--rf-green)] mb-3">Your basket</h2>
              <ul className="divide-y divide-black/5">
                {basketLines.map((l) => (
                  <li key={l.id} className="py-2 flex items-center justify-between text-base md:text-lg">
                    <span>{l.name}</span>
                    <span className="font-medium text-[var(--rf-green)]">{typeof l.price === "number" ? fmtGBP(l.price) : <span className="opacity-60">â€”</span>}</span>
                  </li>
                ))}
              </ul>
              <div className="mt-4 pt-3 border-t border-black/10 flex items-center justify-between">
                <span className="text-lg md:text-xl font-semibold">Total</span>
                <span className="text-xl md:text-2xl font-semibold text-[var(--rf-green)]">{fmtGBP(basketTotal)}</span>
              </div>
            </div>
          </section>
        </div>

        {/* Recipes Summary */}
        <section className="mt-8 bg-white/70 backdrop-blur rounded-2xl p-4 md:p-6 shadow-sm border border-black/5">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-2xl font-semibold text-[var(--rf-green)]">Recipes</h2>
            <div className="billiard w-10 h-10 rounded-full flex items-center justify-center shadow-sm">
              <span className="text-white font-semibold">{totalRecipeCount}</span>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold text-[var(--rf-green-700)] mb-2">Base recipes ({BASE_RECIPES.length})</h3>
              <ul className="list-disc pl-5 space-y-1 text-sm md:text-base">
                {BASE_RECIPES.map((r, i) => (
                  <li key={i}>{r}</li>
                ))}
              </ul>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-[var(--rf-green-700)] mb-2">Unlocked recipes ({unlockedRecipes.length})</h3>
              {unlockedRecipes.length > 0 ? (
                <ul className="list-disc pl-5 space-y-1 text-sm md:text-base">
                  {unlockedRecipes.map((r, i) => (
                    <li key={i}>{r}</li>
                  ))}
                </ul>
              ) : (
                <div className="text-sm text-[#526b5a]">Add an optional item to unlock more ideas.</div>
              )}
            </div>
          </div>
        </section>

        {/* Footer notes to ensure constraints are visible */}
        <footer className="mt-8 text-xs text-[#526b5a]">
          <ul className="list-disc pl-5 space-y-1">
            <li>Pantry checkboxes are always shown (never removed).</li>
            <li>Addâ€‘on options are never reduced or hidden unless explicitly instructed.</li>
            <li>Recipe counts and prices update automatically and accurately.</li>
          </ul>
        </footer>
      </div>
    </div>
  );
}
